@page "/vehicles/browse"
@layout CustomerLayout
@inject IApiService ApiService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using Frontend.Models

<PageTitle>Browse Vehicles - Car Rental</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudStack Spacing="5">
        <!-- Header -->
        <MudStack Spacing="1">
            <MudText Typo="Typo.h3" Style="font-weight: 700; color: #1e293b;">Find Your Perfect Ride</MudText>
            <MudText Typo="Typo.body1" Style="color: #64748b;">
                Choose from our wide selection of quality vehicles
            </MudText>
        </MudStack>

        @if (isLoading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" Style="border-radius: 8px;" />
        }
        else
        {
            <!-- Filters -->
            <MudPaper Elevation="1" Class="pa-5" Style="border-radius: 16px;">
                <MudGrid Spacing="3">
                    <MudItem xs="12" sm="6" md="3">
                        <MudSelect T="int?" 
                                   Label="Category" 
                                   Value="@selectedCategoryId" 
                                   ValueChanged="@((int? value) => OnCategoryChanged(value))"
                                   Clearable="true"
                                   Variant="Variant.Outlined"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Filled.Category">
                            @foreach (var category in categories)
                            {
                                <MudSelectItem T="int?" Value="@category.Id">@category.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudNumericField T="decimal?" 
                                         Label="Max Daily Rate" 
                                         Value="@maxDailyRate"
                                         ValueChanged="@((decimal? value) => OnMaxDailyRateChanged(value))"
                                         Min="0" 
                                         Variant="Variant.Outlined"
                                         Adornment="Adornment.Start" 
                                         AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudNumericField T="int?" 
                                         Label="Min Seats" 
                                         Value="@minSeats"
                                         ValueChanged="@((int? value) => OnMinSeatsChanged(value))"
                                         Min="1" 
                                         Max="15"
                                         Variant="Variant.Outlined"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Filled.AirlineSeatReclineNormal" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Secondary" 
                                   FullWidth="true" 
                                   OnClick="ClearFilters" 
                                   StartIcon="@Icons.Material.Filled.Clear"
                                   Style="height: 56px; border-radius: 12px; border-width: 2px;">
                            Clear Filters
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <!-- Results Count -->
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Style="color: #64748b;" Size="Size.Small" />
                <MudText Typo="Typo.body2" Style="color: #64748b;">
                    Showing <strong style="color: #1e293b;">@filteredVehicles.Count</strong> of <strong style="color: #1e293b;">@vehicles.Count</strong> vehicles
                </MudText>
            </MudStack>

            <!-- Vehicle Grid -->
            <MudGrid Spacing="4">
                @foreach (var vehicle in filteredVehicles)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <MudCard Elevation="2" Class="hover-card" Style="height: 100%; border-radius: 16px; overflow: hidden;">
                            @if (!string.IsNullOrEmpty(vehicle.ImageUrl))
                            {
                                <MudCardMedia Image="@vehicle.ImageUrl" Height="200" />
                            }
                            else
                            {
                                <div style="height: 200px; background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); display: flex; align-items: center; justify-content: center;">
                                    <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Style="color: white; font-size: 4rem; opacity: 0.9;" />
                                </div>
                            }
                            <MudCardContent Class="pa-5">
                                <MudStack Spacing="3">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.h5" Style="font-weight: 700, color: #1e293b;">@vehicle.Brand @vehicle.Model</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #64748b;">@vehicle.Year</MudText>
                                        </MudStack>
                                        @if (vehicle.Status == VehicleStatus.Available)
                                        {
                                            <MudChip T="string" Size="Size.Small" Style="background: #dcfce7; color: #166534; font-weight: 600;">
                                                Available
                                            </MudChip>
                                        }
                                        else
                                        {
                                            <MudChip T="string" Size="Size.Small" Style="background: #f1f5f9; color: #64748b; font-weight: 600;">
                                                Unavailable
                                            </MudChip>
                                        }
                                    </MudStack>
                                    
                                    <MudChip T="string" Size="Size.Small" Style="@(GetCategoryStyle(vehicle.CategoryName))" Icon="@Icons.Material.Filled.Category">
                                        @vehicle.CategoryName
                                    </MudChip>
                                    
                                    <MudDivider />
                                    
                                    <MudGrid Spacing="2">
                                        <MudItem xs="6">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.LocalGasStation" Size="Size.Small" Style="color: #64748b;" />
                                                <MudText Typo="Typo.body2" Style="color: #64748b;">@vehicle.FuelType</MudText>
                                            </MudStack>
                                        </MudItem>
                                        <MudItem xs="6">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.AirlineSeatReclineNormal" Size="Size.Small" Style="color: #64748b;" />
                                                <MudText Typo="Typo.body2" Style="color: #64748b;">@vehicle.SeatingCapacity seats</MudText>
                                            </MudStack>
                                        </MudItem>
                                        <MudItem xs="6">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.Speed" Size="Size.Small" Style="color: #64748b;" />
                                                <MudText Typo="Typo.body2" Style="color: #64748b;">@(vehicle.Mileage.ToString("N0")) km</MudText>
                                            </MudStack>
                                        </MudItem>
                                    </MudGrid>
                                    
                                    <MudDivider />
                                    
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.caption" Style="color: #64748b;">Daily Rate</MudText>
                                            <MudText Typo="Typo.h5" Style="font-weight: 700; color: #0d9488;">$@(vehicle.DailyRate.ToString("N2"))</MudText>
                                        </MudStack>
                                        @if (vehicle.Status == VehicleStatus.Available)
                                        {
                                            <MudButton Variant="Variant.Filled" 
                                                       Color="Color.Primary" 
                                                       StartIcon="@Icons.Material.Filled.EventAvailable"
                                                       OnClick="@(() => RentVehicle(vehicle))"
                                                       Style="font-weight: 600; border-radius: 10px;">
                                                Rent Now
                                            </MudButton>
                                        }
                                        else
                                        {
                                            <MudButton Variant="Variant.Outlined" Disabled="true" Style="border-radius: 10px;">
                                                Not Available
                                            </MudButton>
                                        }
                                    </MudStack>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>

            @if (!filteredVehicles.Any())
            {
                <MudPaper Elevation="1" Class="pa-8 text-center" Style="border-radius: 16px;">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Style="font-size: 5rem; color: #cbd5e1;" />
                    <MudText Typo="Typo.h5" Style="color: #64748b; margin-top: 1rem; font-weight: 600;">No vehicles found</MudText>
                    <MudText Typo="Typo.body2" Style="color: #94a3b8;">Try adjusting your filters or check back later</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="ClearFilters" Style="border-radius: 10px;">
                        Clear Filters
                    </MudButton>
                </MudPaper>
            }
        }
    </MudStack>
</MudContainer>

@code {
    private List<Vehicle> vehicles = new();
    private List<Vehicle> filteredVehicles = new();
    private List<CategoryModel> categories = new();
    private bool isLoading = true;
    
    // Filters
    private int? selectedCategoryId;
    private decimal? maxDailyRate;
    private int? minSeats;

    protected override async Task OnInitializedAsync()
    {
        // Load categories first
        categories = await ApiService.GetCategoriesAsync(activeOnly: true);
        
        // Check for category query parameter from home page
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (uri.Query.Length > 0)
        {
            var queryString = uri.Query.Substring(1); // Remove the leading '?'
            var queryParams = queryString.Split('&');
            foreach (var param in queryParams)
            {
                var keyValue = param.Split('=');
                if (keyValue.Length == 2 && keyValue[0] == "category")
                {
                    var categoryValue = Uri.UnescapeDataString(keyValue[1]);
                    // Try to match the category name from query string to category ID
                    var matchingCategory = categories.FirstOrDefault(c => 
                        c.Name.Equals(categoryValue, StringComparison.OrdinalIgnoreCase));
                    if (matchingCategory != null)
                    {
                        selectedCategoryId = matchingCategory.Id;
                    }
                    break;
                }
            }
        }
        
        await LoadVehicles();
    }

    private async Task LoadVehicles()
    {
        isLoading = true;
        try
        {
            vehicles = await ApiService.GetVehiclesAsync();
            // Only show available vehicles to customers
            vehicles = vehicles.Where(v => v.Status == VehicleStatus.Available).ToList();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading vehicles: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnCategoryChanged(int? value)
    {
        selectedCategoryId = value;
        ApplyFilters();
        StateHasChanged();
    }

    private void OnMaxDailyRateChanged(decimal? value)
    {
        maxDailyRate = value;
        ApplyFilters();
        StateHasChanged();
    }

    private void OnMinSeatsChanged(int? value)
    {
        minSeats = value;
        ApplyFilters();
        StateHasChanged();
    }

    private void ApplyFilters()
    {
        var filtered = vehicles.AsEnumerable();

        if (selectedCategoryId.HasValue)
        {
            filtered = filtered.Where(v => v.CategoryId == selectedCategoryId.Value);
        }

        if (maxDailyRate.HasValue && maxDailyRate.Value > 0)
        {
            filtered = filtered.Where(v => v.DailyRate <= maxDailyRate.Value);
        }

        if (minSeats.HasValue && minSeats.Value > 0)
        {
            filtered = filtered.Where(v => v.SeatingCapacity >= minSeats.Value);
        }

        filteredVehicles = filtered.ToList();
    }

    private void ClearFilters()
    {
        selectedCategoryId = null;
        maxDailyRate = null;
        minSeats = null;
        ApplyFilters();
        StateHasChanged();
    }

    private void RentVehicle(Vehicle vehicle)
    {
        // Navigate to customer booking page with vehicle pre-selected
        if (vehicle != null)
        {
            NavigationManager.NavigateTo($"/book-vehicle/{vehicle.Id}");
        }
    }

    private string GetCategoryStyle(string? categoryName)
    {
        if (string.IsNullOrEmpty(categoryName))
            return "background: #f1f5f9; color: #475569;";
            
        return categoryName.ToLower() switch
        {
            "economy" => "background: #dbeafe; color: #1e40af;",
            "compact" => "background: #e0e7ff; color: #3730a3;",
            "midsize" => "background: #dcfce7; color: #166534;",
            "suv" => "background: #dcfce7; color: #166534;",
            "luxury" => "background: #fef3c7; color: #92400e;",
            "sports" => "background: #fee2e2; color: #991b1b;",
            "van" => "background: #f3e8ff; color: #6b21a8;",
            _ => "background: #f1f5f9; color: #475569;"
        };
    }
}
