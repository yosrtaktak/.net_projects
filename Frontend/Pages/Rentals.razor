@page "/rentals"
@inject IApiService ApiService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using Frontend.Models
@using MudBlazor

<PageTitle>My Rentals - Car Rental System</PageTitle>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold">
                        <i class="bi bi-calendar-check text-primary"></i> My Rentals
                    </h1>
                    <p class="text-muted">Track your rental history and active bookings</p>
                </div>
                <button class="btn btn-primary" @onclick="GoToCreateRental">
                    <i class="bi bi-plus-lg"></i> New Rental
                </button>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading rentals...</p>
        </div>
    }
    else if (!rentals.Any())
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                <h4 class="mt-3">No rentals found</h4>
                <p class="text-muted">You haven't created any rentals yet.</p>
                <button class="btn btn-primary mt-2" @onclick="GoToVehicles">
                    <i class="bi bi-car-front"></i> Browse Vehicles
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="btn-group" role="group">
                    <button type="button" class="btn @(statusFilter == null ? "btn-primary" : "btn-outline-primary")" 
                            @onclick="ClearFilter">
                        All (@allRentals.Count)
                    </button>
                    @foreach (var status in Enum.GetValues<RentalStatus>())
                    {
                        var count = allRentals.Count(r => r.Status == status);
                        <button type="button" class="btn @(statusFilter == status ? "btn-primary" : "btn-outline-primary")" 
                                @onclick="@(() => FilterByStatus(status))">
                            @status (@count)
                        </button>
                    }
                </div>
            </div>
        </div>

        <div class="row g-4">
            @foreach (var rental in rentals)
            {
                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-car-front text-primary"></i>
                                            @if (rental.Vehicle != null)
                                            {
                                                @rental.Vehicle.Brand @rental.Vehicle.Model
                                            }
                                            else
                                            {
                                                <span>Vehicle ID: @rental.VehicleId</span>
                                            }
                                        </h5>
                                        <span class="badge @GetStatusBadgeClass(rental.Status)">@rental.Status</span>
                                    </div>
                                    
                                    @if (rental.Customer != null)
                                    {
                                        <p class="text-muted small mb-2">
                                            <i class="bi bi-person"></i> @rental.Customer.FirstName @rental.Customer.LastName
                                        </p>
                                    }

                                    <div class="row g-3 mt-2">
                                        <div class="col-sm-6">
                                            <small class="text-muted d-block">Start Date</small>
                                            <strong><i class="bi bi-calendar-event"></i> @rental.StartDate.ToString("MMM dd, yyyy")</strong>
                                        </div>
                                        <div class="col-sm-6">
                                            <small class="text-muted d-block">End Date</small>
                                            <strong><i class="bi bi-calendar-event"></i> @rental.EndDate.ToString("MMM dd, yyyy")</strong>
                                        </div>
                                        <div class="col-sm-6">
                                            <small class="text-muted d-block">Duration</small>
                                            <strong>@((rental.EndDate - rental.StartDate).Days) days</strong>
                                        </div>
                                        <div class="col-sm-6">
                                            <small class="text-muted d-block">Created</small>
                                            <strong>@rental.CreatedAt.ToString("MMM dd, yyyy")</strong>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4 d-flex flex-column justify-content-between align-items-end">
                                    <div class="text-end mb-3">
                                        <small class="text-muted d-block">Total Cost</small>
                                        <h3 class="text-primary mb-0">$@(rental.TotalCost.ToString("N2"))</h3>
                                    </div>

                                    @if (userRole == "Admin" || userRole == "Employee")
                                    {
                                        <div class="btn-group-vertical w-100" role="group">
                                            @if (rental.Status == RentalStatus.Active || rental.Status == RentalStatus.Reserved)
                                            {
                                                <button class="btn btn-sm btn-success" @onclick="@(() => CompleteRental(rental.Id))">
                                                    <i class="bi bi-check-circle"></i> Complete
                                                </button>
                                                <button class="btn btn-sm btn-danger" @onclick="@(() => CancelRental(rental.Id))">
                                                    <i class="bi bi-x-circle"></i> Cancel
                                                </button>
                                            }
                                        </div>
                                    }
                                    else if (userRole == "Customer")
                                    {
                                        @if (rental.Status == RentalStatus.Active || rental.Status == RentalStatus.Completed)
                                        {
                                            <div class="btn-group-vertical w-100" role="group">
                                                <button class="btn btn-sm btn-warning" @onclick="@(() => ReportDamage(rental.Id))">
                                                    <i class="bi bi-exclamation-triangle"></i> Report Damage
                                                </button>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Complete Rental Dialog -->
<MudDialog @bind-Visible="showCompleteDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
            Complete Rental
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudNumericField @bind-Value="endMileage" 
                        Label="End Mileage" 
                        Variant="Variant.Outlined" 
                        Min="0"
                        HelperText="Enter the vehicle's mileage at return" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showCompleteDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Success" Variant="Variant.Filled" OnClick="ConfirmCompleteRental">Complete</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<Rental> allRentals = new();
    private List<Rental> rentals = new();
    private RentalStatus? statusFilter = null;
    private bool isLoading = true;
    private string? userRole;
    
    // Dialog state
    private bool showCompleteDialog = false;
    private int selectedRentalId = 0;
    private int endMileage = 0;

    protected override async Task OnInitializedAsync()
    {
        userRole = await AuthService.GetRoleAsync();
        await LoadRentals();
    }

    private async Task LoadRentals()
    {
        isLoading = true;
        allRentals = await ApiService.GetRentalsAsync();
        rentals = allRentals;
        isLoading = false;
    }

    private void ClearFilter()
    {
        statusFilter = null;
        rentals = allRentals;
    }

    private void FilterByStatus(RentalStatus status)
    {
        statusFilter = status;
        rentals = allRentals.Where(r => r.Status == status).ToList();
    }

    private async Task CompleteRental(int rentalId)
    {
        // Find the rental to get its vehicle mileage
        var rental = allRentals.FirstOrDefault(r => r.Id == rentalId);
        if (rental?.Vehicle != null)
        {
            endMileage = rental.Vehicle.Mileage;
        }
        
        selectedRentalId = rentalId;
        showCompleteDialog = true;
    }

    private async Task ConfirmCompleteRental()
    {
        try
        {
            var success = await ApiService.CompleteRentalAsync(selectedRentalId, endMileage);
            
            if (success)
            {
                Snackbar.Add("Rental completed successfully", Severity.Success);
                showCompleteDialog = false;
                await LoadRentals();
            }
            else
            {
                Snackbar.Add("Failed to complete rental", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task CancelRental(int rentalId)
    {
        var success = await ApiService.CancelRentalAsync(rentalId);
        
        if (success)
        {
            await LoadRentals();
        }
    }

    private string GetStatusBadgeClass(RentalStatus status)
    {
        return status switch
        {
            RentalStatus.Reserved => "bg-info",
            RentalStatus.Active => "bg-success",
            RentalStatus.Completed => "bg-secondary",
            RentalStatus.Cancelled => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private void GoToCreateRental()
    {
        NavigationManager.NavigateTo("/rentals/create");
    }

    private void GoToVehicles()
    {
        NavigationManager.NavigateTo("/vehicles");
    }

    private void ReportDamage(int rentalId)
    {
        NavigationManager.NavigateTo($"/rentals/{rentalId}/report-damage");
    }
}
