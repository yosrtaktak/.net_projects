@page "/customers"
@layout AdminLayout
@inject Frontend.Services.IApiService ApiService
@inject Frontend.Services.IAuthService AuthService
@inject NavigationManager NavigationManager
@inject MudBlazor.ISnackbar Snackbar
@using Frontend.Models

<PageTitle>Customers - Car Rental System</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="px-0">
    @if (isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (!isAuthorized)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="my-4">
            <strong>Access Denied</strong> - Admin or Employee privileges required.
        </MudAlert>
    }
    else
    {
        <MudStack Spacing="4">
            <!-- Header -->
            <MudPaper Elevation="0" Class="pa-4" Style="background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%); color: white;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.h4" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                            Customer Management
                        </MudText>
                        <MudText Typo="Typo.body1" Style="opacity: 0.9;">
                            View and manage customer information
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>

            <!-- Statistics Cards -->
            <MudGrid Spacing="3">
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.h3" Style="font-weight: 700;">@customers.Count</MudText>
                                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">Total Customers</MudText>
                                </MudStack>
                                <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Style="opacity: 0.8;" />
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.h3" Style="font-weight: 700;">@customers.Count(c => c.Tier == CustomerTier.Gold)</MudText>
                                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">Gold Members</MudText>
                                </MudStack>
                                <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Large" Style="opacity: 0.8;" />
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.h3" Style="font-weight: 700;">@customers.Count(c => c.Tier == CustomerTier.Platinum)</MudText>
                                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">Platinum Members</MudText>
                                </MudStack>
                                <MudIcon Icon="@Icons.Material.Filled.Grade" Size="Size.Large" Style="opacity: 0.8;" />
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.h3" Style="font-weight: 700;">@customers.Count(c => c.RegistrationDate.Month == DateTime.Now.Month)</MudText>
                                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">New This Month</MudText>
                                </MudStack>
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Large" Style="opacity: 0.8;" />
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <!-- Search Bar -->
            <MudPaper Elevation="2" Class="pa-4">
                <MudTextField T="string" 
                              Label="Search Customers" 
                              @bind-Value="searchTerm" 
                              Immediate="true" 
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Placeholder="Name, Email, Phone, License Number..." />
            </MudPaper>

            <!-- Customers Table -->
            @if (filteredCustomers.Any())
            {
                <MudPaper Elevation="2">
                    <MudTable Items="@filteredCustomers" Hover="true" Striped="true" Dense="true" Elevation="0">
                        <HeaderContent>
                            <MudTh Style="font-weight: 600;">ID</MudTh>
                            <MudTh Style="font-weight: 600;">Name</MudTh>
                            <MudTh Style="font-weight: 600;">Contact</MudTh>
                            <MudTh Style="font-weight: 600;">License</MudTh>
                            <MudTh Style="font-weight: 600;">Tier</MudTh>
                            <MudTh Style="font-weight: 600;">Registered</MudTh>
                            <MudTh Style="font-weight: 600;">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="ID">
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">#@context.Id</MudText>
                            </MudTd>
                            <MudTd DataLabel="Name">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2" Style="font-weight: 600;">@context.FirstName @context.LastName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        <MudIcon Icon="@Icons.Material.Filled.Cake" Size="Size.Small" /> @(context.DateOfBirth?.ToString("MMM dd, yyyy") ?? "N/A")
                                    </MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Contact">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" /> @context.Email
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" /> @context.PhoneNumber
                                    </MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="License">
                                <MudChip T="string" Size="Size.Small" Color="Color.Default" Style="font-family: monospace;">
                                    @context.DriverLicenseNumber
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Tier">
                                <MudChip T="string" Size="Size.Small" Color="@GetTierColor(context.Tier)" Style="font-weight: 600;">
                                    @context.Tier
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Registered">
                                <MudText Typo="Typo.body2">@context.RegistrationDate.ToString("MMM dd, yyyy")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Actions">
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Visibility"
                                           OnClick="@(() => ViewCustomerDetails(context.Id))">
                                    View
                                </MudButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            }
            else
            {
                <MudPaper Elevation="2" Class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" Style="font-size: 5rem; opacity: 0.5;" />
                    <MudText Typo="Typo.h5" Color="Color.Secondary" Class="mt-4" Style="font-weight: 600;">No customers found</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary">Try adjusting your search terms</MudText>
                </MudPaper>
            }
        </MudStack>
    }
</MudContainer>

@code {
    private List<Customer> customers = new();
    private List<Customer> filteredCustomers = new();
    private string searchTerm = string.Empty;
    private bool isLoading = true;
    private bool isAuthorized = false;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        
        var role = await AuthService.GetRoleAsync();
        isAuthorized = role == "Admin" || role == "Employee";

        if (!isAuthorized)
        {
            isLoading = false;
            return;
        }

        await LoadCustomers();
    }

    protected override async Task OnParametersSetAsync()
    {
        FilterCustomers();
        await base.OnParametersSetAsync();
    }

    private async Task LoadCustomers()
    {
        isLoading = true;
        try
        {
            customers = await ApiService.GetCustomersAsync();
            FilterCustomers();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading customers: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterCustomers()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredCustomers = customers;
        }
        else
        {
            var term = searchTerm.ToLower();
            filteredCustomers = customers.Where(c =>
                c.FirstName.ToLower().Contains(term) ||
                c.LastName.ToLower().Contains(term) ||
                c.Email.ToLower().Contains(term) ||
                c.PhoneNumber.Contains(term) ||
                c.DriverLicenseNumber.ToLower().Contains(term)
            ).ToList();
        }
    }

    private void ViewCustomerDetails(string userId)
    {
        NavigationManager.NavigateTo($"/customers/{userId}");
    }

    private Color GetTierColor(CustomerTier tier)
    {
        return tier switch
        {
            CustomerTier.Standard => Color.Default,
            CustomerTier.Silver => Color.Secondary,
            CustomerTier.Gold => Color.Warning,
            CustomerTier.Platinum => Color.Primary,
            _ => Color.Default
        };
    }
}
