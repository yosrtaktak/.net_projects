@page "/admin/profile"
@layout AdminLayout
@inject IApiService ApiService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using Frontend.Models

<PageTitle>My Profile - Car Rental System</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudStack Spacing="4">
        <!-- Header -->
        <MudPaper Elevation="0" Class="pa-4" Style="background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%);">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h3" Style="color: white;">
                        <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Size="Size.Large" Class="mr-2" />
                        <strong>My Profile</strong>
                    </MudText>
                    <MudText Typo="Typo.body1" Style="color: rgba(255,255,255,0.9);">
                        Manage your personal information
                    </MudText>
                </MudStack>
                @if (user != null)
                {
                    <MudChip T="string" 
                             Size="Size.Large" 
                             Color="Color.Warning" 
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.AdminPanelSettings">
                        @userRole
                    </MudChip>
                }
            </MudStack>
        </MudPaper>

        @if (isLoading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else if (user == null)
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
                <strong>Profile Not Found</strong> - Unable to load your profile information.
            </MudAlert>
        }
        else
        {
            <MudGrid Spacing="3">
                <!-- Personal Information -->
                <MudItem xs="12">
                    <MudPaper Elevation="2" Class="pa-4">
                        <MudStack Spacing="3">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h5">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" />
                                    Personal Information
                                </MudText>
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Primary" 
                                           StartIcon="@Icons.Material.Filled.Edit"
                                           OnClick="OpenEditDialog">
                                    Edit Profile
                                </MudButton>
                            </MudStack>
                            
                            <MudDivider />

                            <MudGrid Spacing="2">
                                <MudItem xs="12" sm="6">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">First Name</MudText>
                                        <MudText Typo="Typo.body1"><strong>@user.FirstName</strong></MudText>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Last Name</MudText>
                                        <MudText Typo="Typo.body1"><strong>@user.LastName</strong></MudText>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Email</MudText>
                                        <MudText Typo="Typo.body1">
                                            <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Class="mr-1" />
                                            @user.Email
                                        </MudText>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Phone Number</MudText>
                                        <MudText Typo="Typo.body1">
                                            <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Class="mr-1" />
                                            @user.PhoneNumber
                                        </MudText>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Cake" Color="Color.Secondary" />
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Date of Birth</MudText>
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">@(user.DateOfBirth?.ToString("MMM dd, yyyy") ?? "Not provided")</MudText>
                                        </MudStack>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Driver's License</MudText>
                                        <MudText Typo="Typo.body1">
                                            <MudIcon Icon="@Icons.Material.Filled.CreditCard" Size="Size.Small" Class="mr-1" />
                                            @user.DriverLicenseNumber
                                        </MudText>
                                    </MudStack>
                                </MudItem>

                                @if (!string.IsNullOrEmpty(user.Address))
                                {
                                    <MudItem xs="12">
                                        <MudStack Spacing="1">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Address</MudText>
                                            <MudText Typo="Typo.body1">
                                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                                @user.Address
                                            </MudText>
                                        </MudStack>
                                    </MudItem>
                                }

                                <MudItem xs="12">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Username</MudText>
                                        <MudText Typo="Typo.body1">
                                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" />
                                            @user.UserName
                                        </MudText>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Registration Date</MudText>
                                        <MudText Typo="Typo.body1">
                                            <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" Class="mr-1" />
                                            @user.RegistrationDate.ToString("MMMM dd, yyyy")
                                        </MudText>
                                    </MudStack>
                                </MudItem>
                            </MudGrid>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }
    </MudStack>
</MudContainer>

<!-- Edit Profile Dialog -->
<MudDialog @bind-Visible="showEditDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
            Edit Profile
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6">
                    <MudTextField Label="First Name" 
                                  @bind-Value="editModel.FirstName" 
                                  Variant="Variant.Outlined"
                                  Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="Last Name" 
                                  @bind-Value="editModel.LastName" 
                                  Variant="Variant.Outlined"
                                  Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="Phone Number" 
                                  @bind-Value="editModel.PhoneNumber" 
                                  Variant="Variant.Outlined"
                                  Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="Driver's License" 
                                  @bind-Value="editModel.DriverLicenseNumber" 
                                  Variant="Variant.Outlined"
                                  Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker Label="Date of Birth" 
                                   @bind-Date="editModel.DateOfBirth" 
                                   Variant="Variant.Outlined"
                                   MaxDate="DateTime.Now.AddYears(-18)" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField Label="Address" 
                                  @bind-Value="editModel.Address" 
                                  Variant="Variant.Outlined"
                                  Lines="2" />
                </MudItem>
            </MudGrid>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseEditDialog" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="SaveProfile" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save">
            Save Changes
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private UserProfileDto? user;
    private bool isLoading = true;
    private string? userRole;
    private bool showEditDialog = false;
    private UpdateProfileDto editModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadProfile();
    }

    private async Task LoadProfile()
    {
        isLoading = true;
        try
        {
            userRole = await AuthService.GetRoleAsync();
            user = await ApiService.GetMyUserProfileAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading profile: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenEditDialog()
    {
        if (user != null)
        {
            editModel = new UpdateProfileDto
            {
                FirstName = user.FirstName,
                LastName = user.LastName,
                PhoneNumber = user.PhoneNumber,
                DriverLicenseNumber = user.DriverLicenseNumber,
                DateOfBirth = user.DateOfBirth,
                Address = user.Address
            };
            showEditDialog = true;
        }
    }

    private void CloseEditDialog()
    {
        showEditDialog = false;
    }

    private async Task SaveProfile()
    {
        try
        {
            await ApiService.UpdateMyUserProfileAsync(editModel);
            Snackbar.Add("Profile updated successfully!", Severity.Success);
            showEditDialog = false;
            await LoadProfile();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating profile: {ex.Message}", Severity.Error);
        }
    }
}
