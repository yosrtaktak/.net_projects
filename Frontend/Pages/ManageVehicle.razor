@page "/vehicles/add"
@page "/vehicles/edit/{Id:int}"
@layout AdminLayout
@inject IApiService ApiService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using Frontend.Models

<PageTitle>@(Id.HasValue ? "Edit" : "Add") Vehicle - Car Rental System</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    @if (!canManageVehicles)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="my-4">
            <strong>Access Denied</strong> - Admin or Employee privileges required.
        </MudAlert>
    }
    else
    {
        <MudStack Spacing="4">
            <!-- Header with Breadcrumb -->
            <MudStack Spacing="2">
                <MudBreadcrumbs Items="_breadcrumbs"></MudBreadcrumbs>
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.h4">
                            <MudIcon Icon="@(Id.HasValue ? Icons.Material.Filled.Edit : Icons.Material.Filled.Add)" Class="mr-2" />
                            <strong>@(Id.HasValue ? "Edit" : "Add New") Vehicle</strong>
                        </MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @(Id.HasValue ? "Update vehicle information and specifications" : "Add a new vehicle to your fleet")
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudStack>

            @if (isLoading && Id.HasValue)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            }
            else
            {
                <EditForm Model="@vehicleModel" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />

                    <MudPaper Elevation="2" Class="pa-6">
                        <MudStack Spacing="4">
                            <!-- Basic Information Section -->
                            <MudStack Spacing="3">
                                <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 600;">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                                    Basic Information
                                </MudText>
                                <MudDivider />
                                
                                <MudGrid Spacing="3">
                                    <MudItem xs="12" sm="6">
                                        <MudTextField T="string" 
                                                      @bind-Value="vehicleModel.Brand" 
                                                      Label="Brand" 
                                                      Variant="Variant.Outlined"
                                                      Required="true"
                                                      RequiredError="Brand is required"
                                                      Placeholder="e.g., Toyota, BMW, Mercedes" />
                                    </MudItem>

                                    <MudItem xs="12" sm="6">
                                        <MudTextField T="string" 
                                                      @bind-Value="vehicleModel.Model" 
                                                      Label="Model" 
                                                      Variant="Variant.Outlined"
                                                      Required="true"
                                                      RequiredError="Model is required"
                                                      Placeholder="e.g., Camry, X5, E-Class" />
                                    </MudItem>

                                    <MudItem xs="12" sm="6">
                                        <MudTextField T="string" 
                                                      @bind-Value="vehicleModel.RegistrationNumber" 
                                                      Label="Registration Number" 
                                                      Variant="Variant.Outlined"
                                                      Required="true"
                                                      RequiredError="Registration number is required"
                                                      Placeholder="e.g., ABC-1234" />
                                    </MudItem>

                                    <MudItem xs="12" sm="6">
                                        <MudNumericField T="int" 
                                                         @bind-Value="vehicleModel.Year" 
                                                         Label="Year" 
                                                         Variant="Variant.Outlined"
                                                         Min="1900" 
                                                         Max="2099"
                                                         Required="true" />
                                    </MudItem>
                                </MudGrid>
                            </MudStack>

                            <!-- Category & Pricing Section -->
                            <MudStack Spacing="3">
                                <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 600;">
                                    <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" Class="mr-2" />
                                    Category & Pricing
                                </MudText>
                                <MudDivider />
                                
                                <MudGrid Spacing="3">
                                    <MudItem xs="12" sm="6">
                                        @if (isLoadingCategories)
                                        {
                                            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="56px" />
                                        }
                                        else if (!dbCategories.Any())
                                        {
                                            <MudAlert Severity="Severity.Warning" Dense="true" Variant="Variant.Outlined">
                                                <MudText Typo="Typo.body2">
                                                    No categories found. <MudLink Href="/admin/categories" Color="Color.Primary"><strong>Create categories first</strong></MudLink>
                                                </MudText>
                                            </MudAlert>
                                        }
                                        else
                                        {
                                            <MudSelect T="VehicleCategory" 
                                                       @bind-Value="vehicleModel.Category" 
                                                       Label="Category" 
                                                       Variant="Variant.Outlined"
                                                       Required="true"
                                                       AnchorOrigin="Origin.BottomCenter"
                                                       HelperText="@GetCategoryHelperText()"
                                                       AdornmentIcon="@Icons.Material.Filled.Category"
                                                       Adornment="Adornment.Start">
                                                @foreach (var dbCategory in dbCategories.Where(c => c.IsActive).OrderBy(c => c.DisplayOrder))
                                                {
                                                    var enumValue = ParseCategoryName(dbCategory.Name);
                                                    if (enumValue.HasValue)
                                                    {
                                                        <MudSelectItem T="VehicleCategory" Value="@enumValue.Value">
                                                            <div style="padding: 8px 0;">
                                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="width: 100%;">
                                                                    <MudIcon Icon="@Icons.Material.Filled.LocalOffer" 
                                                                             Size="Size.Medium" 
                                                                             Color="@GetCategoryColor(enumValue.Value)" />
                                                                    <MudStack Spacing="0" Style="flex: 1;">
                                                                        <MudText Typo="Typo.body1" Style="font-weight: 500;">
                                                                            @dbCategory.Name
                                                                        </MudText>
                                                                        @if (!string.IsNullOrEmpty(dbCategory.Description))
                                                                        {
                                                                            <MudText Typo="Typo.caption" 
                                                                                     Color="Color.Secondary" 
                                                                                     Style="line-height: 1.4; margin-top: 2px;">
                                                                                @dbCategory.Description
                                                                            </MudText>
                                                                        }
                                                                    </MudStack>
                                                                </MudStack>
                                                            </div>
                                                        </MudSelectItem>
                                                    }
                                                }
                                            </MudSelect>
                                        }
                                    </MudItem>

                                    <MudItem xs="12" sm="6">
                                        <MudNumericField T="decimal" 
                                                         @bind-Value="vehicleModel.DailyRate" 
                                                         Label="Daily Rate" 
                                                         Variant="Variant.Outlined"
                                                         Min="0m" 
                                                         Step="0.01m"
                                                         Adornment="Adornment.Start" 
                                                         AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                                                         Required="true" />
                                    </MudItem>

                                    @if (Id.HasValue)
                                    {
                                        <MudItem xs="12">
                                            <MudSelect T="VehicleStatus" 
                                                       @bind-Value="vehicleModel.Status" 
                                                       Label="Status" 
                                                       Variant="Variant.Outlined"
                                                       Required="true">
                                                @foreach (var status in Enum.GetValues<VehicleStatus>())
                                                {
                                                    <MudSelectItem T="VehicleStatus" Value="@status">
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                            <MudIcon Icon="@GetStatusIcon(status)" Size="Size.Small" Color="@GetStatusColor(status)" />
                                                            <MudText>@status</MudText>
                                                        </MudStack>
                                                    </MudSelectItem>
                                                }
                                            </MudSelect>
                                        </MudItem>
                                    }
                                </MudGrid>
                            </MudStack>

                            <!-- Specifications Section -->
                            <MudStack Spacing="3">
                                <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 600;">
                                    <MudIcon Icon="@Icons.Material.Filled.Speed" Size="Size.Small" Class="mr-2" />
                                    Specifications
                                </MudText>
                                <MudDivider />
                                
                                <MudGrid Spacing="3">
                                    <MudItem xs="12" sm="4">
                                        <MudTextField T="string" 
                                                      @bind-Value="vehicleModel.FuelType" 
                                                      Label="Fuel Type" 
                                                      Variant="Variant.Outlined"
                                                      Placeholder="e.g., Gasoline, Diesel, Electric"
                                                      Adornment="Adornment.Start"
                                                      AdornmentIcon="@Icons.Material.Filled.LocalGasStation" />
                                    </MudItem>

                                    <MudItem xs="12" sm="4">
                                        <MudNumericField T="int" 
                                                         @bind-Value="vehicleModel.SeatingCapacity" 
                                                         Label="Seating Capacity" 
                                                         Variant="Variant.Outlined"
                                                         Min="1" 
                                                         Max="50"
                                                         Required="true"
                                                         Adornment="Adornment.Start"
                                                         AdornmentIcon="@Icons.Material.Filled.People" />
                                    </MudItem>

                                    <MudItem xs="12" sm="4">
                                        <MudNumericField T="int" 
                                                         @bind-Value="vehicleModel.Mileage" 
                                                         Label="Mileage (km)" 
                                                         Variant="Variant.Outlined"
                                                         Min="0"
                                                         Required="true"
                                                         Adornment="Adornment.Start"
                                                         AdornmentIcon="@Icons.Material.Filled.Speed" />
                                    </MudItem>

                                    <MudItem xs="12">
                                        <MudTextField T="string" 
                                                      @bind-Value="vehicleModel.ImageUrl" 
                                                      Label="Image URL" 
                                                      Variant="Variant.Outlined"
                                                      Placeholder="https://example.com/image.jpg"
                                                      Adornment="Adornment.Start"
                                                      AdornmentIcon="@Icons.Material.Filled.Image"
                                                      HelperText="Enter a valid URL for the vehicle image" />
                                    </MudItem>

                                    @if (!string.IsNullOrEmpty(vehicleModel.ImageUrl))
                                    {
                                        <MudItem xs="12">
                                            <MudText Typo="Typo.body2" Color="Color.Secondary" GutterBottom="true">Image Preview:</MudText>
                                            <MudImage Src="@vehicleModel.ImageUrl" 
                                                      Alt="Vehicle Preview" 
                                                      Elevation="2" 
                                                      Class="rounded-lg" 
                                                      ObjectFit="ObjectFit.Cover"
                                                      Height="200"
                                                      Width="300" />
                                        </MudItem>
                                    }
                                </MudGrid>
                            </MudStack>

                            <!-- Form Actions -->
                            <MudDivider />
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Default" 
                                           StartIcon="@Icons.Material.Filled.ArrowBack"
                                           OnClick="Cancel">
                                    Back to Vehicles
                                </MudButton>
                                
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           ButtonType="ButtonType.Submit"
                                           StartIcon="@Icons.Material.Filled.Save"
                                           Disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                        <span>Saving...</span>
                                    }
                                    else
                                    {
                                        <span>@(Id.HasValue ? "Update" : "Create") Vehicle</span>
                                    }
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </EditForm>
            }
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter]
    public int? Id { get; set; }

    private VehicleFormModel vehicleModel = new();
    private List<CategoryModel> dbCategories = new();
    private bool canManageVehicles = false;
    private bool isLoading = false;
    private bool isLoadingCategories = false;
    private bool isSaving = false;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        var role = await AuthService.GetRoleAsync();
        canManageVehicles = role == "Admin" || role == "Employee";

        if (!canManageVehicles)
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        SetupBreadcrumbs();
        await LoadCategories();

        if (Id.HasValue)
        {
            await LoadVehicle();
        }
        else
        {
            // Set defaults for new vehicle
            vehicleModel.Year = DateTime.Now.Year;
            vehicleModel.Category = VehicleCategory.Economy;
            vehicleModel.SeatingCapacity = 5;
        }
    }

    private void SetupBreadcrumbs()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Dashboard", href: "/admin", icon: Icons.Material.Filled.Dashboard),
            new BreadcrumbItem("Vehicles", href: "/vehicles/manage", icon: Icons.Material.Filled.DirectionsCar),
            new BreadcrumbItem(Id.HasValue ? "Edit" : "Add", href: null, disabled: true)
        };
    }

    private async Task LoadCategories()
    {
        isLoadingCategories = true;
        try
        {
            dbCategories = await ApiService.GetCategoriesAsync(activeOnly: true);
            
            if (!dbCategories.Any())
            {
                Snackbar.Add("No active categories found. Please create categories first.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading categories: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoadingCategories = false;
        }
    }

    private VehicleCategory? ParseCategoryName(string categoryName)
    {
        // Map database category names to enum values
        return categoryName.ToLower() switch
        {
            "economy" => VehicleCategory.Economy,
            "compact" => VehicleCategory.Compact,
            "midsize" => VehicleCategory.Midsize,
            "suv" => VehicleCategory.SUV,
            "luxury" => VehicleCategory.Luxury,
            "van" => VehicleCategory.Van,
            "sports" => VehicleCategory.Sports,
            _ => null
        };
    }

    private string GetCategoryHelperText()
    {
        var selectedCategory = dbCategories.FirstOrDefault(c => 
            ParseCategoryName(c.Name) == vehicleModel.Category);
        
        if (selectedCategory != null)
        {
            return selectedCategory.Description ?? "Select a category for this vehicle";
        }
        
        return "Select a category for this vehicle";
    }

    private async Task LoadVehicle()
    {
        if (!Id.HasValue) return;
        
        isLoading = true;
        try
        {
            var vehicle = await ApiService.GetVehicleAsync(Id.Value);
            
            if (vehicle != null)
            {
                vehicleModel = new VehicleFormModel
                {
                    Brand = vehicle.Brand,
                    Model = vehicle.Model,
                    RegistrationNumber = vehicle.RegistrationNumber,
                    Year = vehicle.Year,
                    Category = vehicle.Category,
                    DailyRate = vehicle.DailyRate,
                    Status = vehicle.Status,
                    ImageUrl = vehicle.ImageUrl,
                    Mileage = vehicle.Mileage,
                    FuelType = vehicle.FuelType,
                    SeatingCapacity = vehicle.SeatingCapacity
                };
            }
            else
            {
                Snackbar.Add("Vehicle not found.", Severity.Error);
                NavigationManager.NavigateTo("/vehicles/manage");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading vehicle: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        if (!dbCategories.Any())
        {
            Snackbar.Add("Cannot create vehicle without categories. Please create categories first.", Severity.Error);
            return;
        }

        isSaving = true;

        try
        {
            if (Id.HasValue)
            {
                // Update existing vehicle
                var vehicle = new Vehicle
                {
                    Id = Id.Value,
                    Brand = vehicleModel.Brand,
                    Model = vehicleModel.Model,
                    RegistrationNumber = vehicleModel.RegistrationNumber,
                    Year = vehicleModel.Year,
                    Category = vehicleModel.Category,
                    DailyRate = vehicleModel.DailyRate,
                    Status = vehicleModel.Status,
                    ImageUrl = vehicleModel.ImageUrl,
                    Mileage = vehicleModel.Mileage,
                    FuelType = vehicleModel.FuelType,
                    SeatingCapacity = vehicleModel.SeatingCapacity
                };

                var success = await ApiService.UpdateVehicleAsync(Id.Value, vehicle);
                
                if (success)
                {
                    Snackbar.Add($"{vehicleModel.Brand} {vehicleModel.Model} updated successfully!", Severity.Success);
                    await Task.Delay(500);
                    NavigationManager.NavigateTo("/vehicles/manage");
                }
                else
                {
                    Snackbar.Add("Failed to update vehicle. Please try again.", Severity.Error);
                }
            }
            else
            {
                // Create new vehicle
                var request = new CreateVehicleRequest
                {
                    Brand = vehicleModel.Brand,
                    Model = vehicleModel.Model,
                    RegistrationNumber = vehicleModel.RegistrationNumber,
                    Year = vehicleModel.Year,
                    Category = vehicleModel.Category,
                    DailyRate = vehicleModel.DailyRate,
                    ImageUrl = vehicleModel.ImageUrl,
                    Mileage = vehicleModel.Mileage,
                    FuelType = vehicleModel.FuelType,
                    SeatingCapacity = vehicleModel.SeatingCapacity
                };

                var result = await ApiService.CreateVehicleAsync(request);
                
                if (result != null)
                {
                    Snackbar.Add($"{vehicleModel.Brand} {vehicleModel.Model} created successfully!", Severity.Success);
                    await Task.Delay(500);
                    NavigationManager.NavigateTo("/vehicles/manage");
                }
                else
                {
                    Snackbar.Add("Failed to create vehicle. Please check all fields and try again.", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/vehicles/manage");
    }

    private Color GetStatusColor(VehicleStatus status)
    {
        return status switch
        {
            VehicleStatus.Available => Color.Success,
            VehicleStatus.Reserved => Color.Info,
            VehicleStatus.Rented => Color.Warning,
            VehicleStatus.Maintenance => Color.Warning,
            VehicleStatus.Retired => Color.Error,
            _ => Color.Default
        };
    }

    private string GetStatusIcon(VehicleStatus status)
    {
        return status switch
        {
            VehicleStatus.Available => Icons.Material.Filled.CheckCircle,
            VehicleStatus.Reserved => Icons.Material.Filled.EventNote,
            VehicleStatus.Rented => Icons.Material.Filled.DriveEta,
            VehicleStatus.Maintenance => Icons.Material.Filled.Build,
            VehicleStatus.Retired => Icons.Material.Filled.Cancel,
            _ => Icons.Material.Filled.Help
        };
    }

    private Color GetCategoryColor(VehicleCategory category)
    {
        return category switch
        {
            VehicleCategory.Economy => Color.Info,
            VehicleCategory.Compact => Color.Primary,
            VehicleCategory.Midsize => Color.Success,
            VehicleCategory.SUV => Color.Success,
            VehicleCategory.Luxury => Color.Warning,
            VehicleCategory.Sports => Color.Error,
            VehicleCategory.Van => Color.Secondary,
            _ => Color.Default
        };
    }

    public class VehicleFormModel
    {
        public string Brand { get; set; } = string.Empty;
        public string Model { get; set; } = string.Empty;
        public string RegistrationNumber { get; set; } = string.Empty;
        public int Year { get; set; }
        public VehicleCategory Category { get; set; }
        public decimal DailyRate { get; set; }
        public VehicleStatus Status { get; set; } = VehicleStatus.Available;
        public string? ImageUrl { get; set; }
        public int Mileage { get; set; }
        public string? FuelType { get; set; }
        public int SeatingCapacity { get; set; }
    }
}
