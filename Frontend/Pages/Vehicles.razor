@page "/vehicles"
@inject IApiService ApiService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject HttpClient HttpClient
@using Frontend.Models
@using Frontend.Services

<PageTitle>Vehicles - Car Rental System</PageTitle>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-6 fw-bold">
                <i class="bi bi-car-front-fill text-primary"></i> @(isAdmin || isEmployee ? "Manage Vehicles" : "Available Vehicles")
            </h1>
            <p class="text-muted">@(isAdmin || isEmployee ? "Manage fleet, schedule maintenance, and report damages" : "Browse our fleet of quality vehicles")</p>
        </div>
        @if (isAdmin || isEmployee)
        {
            <div class="col-md-4 text-end">
                <button class="btn btn-success btn-lg" @onclick="GoToAddVehicle">
                    <i class="bi bi-plus-circle me-2"></i>Add Vehicle
                </button>
            </div>
        }
    </div>

    <!-- Category Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Category</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-sm @(selectedCategoryId == null ? "btn-primary" : "btn-outline-primary")" 
                                        @onclick="() => FilterByCategoryId(null)">
                                    All
                                </button>
                            </div>
                        </div>
                        @if (isAdmin || isEmployee)
                        {
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" @bind="filterStatus" @bind:event="onchange">
                                    <option value="">All Status</option>
                                    @foreach (var status in Enum.GetValues<VehicleStatus>())
                                    {
                                        <option value="@((int)status)">@status</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Search</label>
                                <input type="text" class="form-control" @bind="searchText" @bind:event="oninput" placeholder="Brand, Model, Registration..." />
                            </div>
                        }
                    </div>
                    <div class="btn-group flex-wrap mt-2" role="group">
                        @foreach (var category in categories)
                        {
                            <button type="button" class="btn btn-sm @(selectedCategoryId == category.Id ? "btn-primary" : "btn-outline-primary")" 
                                    @onclick="() => FilterByCategoryId(category.Id)">
                                @category.Name
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading vehicles...</p>
        </div>
    }
    else if (!vehicles.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>No vehicles found in this category.
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle me-2"></i>@successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
            </div>
        }

        <div class="row g-4">
            @foreach (var vehicle in vehicles)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm border-0 hover-card @GetVehicleCardClass(vehicle.Status)">
                        @if (!string.IsNullOrEmpty(vehicle.ImageUrl))
                        {
                            <img src="@vehicle.ImageUrl" class="card-img-top" alt="@vehicle.Brand @vehicle.Model" 
                                 style="height: 200px; object-fit: cover;">
                        }
                        else
                        {
                            <div class="bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                <i class="bi bi-car-front text-secondary" style="font-size: 4rem;"></i>
                            </div>
                        }
                        
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">@vehicle.Brand @vehicle.Model</h5>
                                <span class="badge @GetStatusBadgeClass(vehicle.Status)">
                                    @vehicle.Status
                                </span>
                            </div>
                            
                            <p class="text-muted small mb-3">
                                <span class="badge bg-secondary">@vehicle.CategoryName</span>
                                <span class="ms-2">@vehicle.Year</span>
                            </p>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between small text-muted mb-1">
                                    <span><i class="bi bi-fuel-pump"></i> @vehicle.FuelType</span>
                                    <span><i class="bi bi-people"></i> @vehicle.SeatingCapacity seats</span>
                                </div>
                                <div class="d-flex justify-content-between small text-muted">
                                    <span><i class="bi bi-speedometer"></i> @vehicle.Mileage.ToString("N0") km</span>
                                    <span><i class="bi bi-credit-card"></i> $@vehicle.DailyRate/day</span>
                                </div>
                                @if (isAdmin || isEmployee)
                                {
                                    <div class="small text-muted mt-1">
                                        <i class="bi bi-hash"></i> @vehicle.RegistrationNumber
                                    </div>
                                }
                            </div>

                            @if (isAdmin || isEmployee)
                            {
                                <div class="d-grid gap-2">
                                    @if (vehicle.Status == VehicleStatus.Maintenance)
                                    {
                                        <button class="btn btn-warning btn-sm" @onclick="() => ShowMaintenanceModal(vehicle)">
                                            <i class="bi bi-wrench"></i> Schedule Maintenance
                                        </button>
                                    }
                                    
                                    <button class="btn btn-outline-danger btn-sm" @onclick="() => ShowDamageModal(vehicle)">
                                        <i class="bi bi-exclamation-triangle"></i> Report Damage
                                    </button>

                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" @onclick="() => ViewDetails(vehicle.Id)">
                                            <i class="bi bi-info-circle"></i> Details
                                        </button>
                                        <button class="btn btn-outline-secondary" @onclick="() => EditVehicle(vehicle.Id)">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        @if (isAdmin)
                                        {
                                            <button class="btn btn-outline-danger" @onclick="() => DeleteVehicle(vehicle.Id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 class="text-primary mb-0">$@vehicle.DailyRate.ToString("0.00")/day</h4>
                                    </div>
                                    <button class="btn btn-primary" @onclick="() => ViewDetails(vehicle.Id)">
                                        <i class="bi bi-info-circle"></i> Details
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Schedule Maintenance Modal -->
    @if (showMaintenanceModal && selectedVehicle != null)
    {
        <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-wrench text-warning me-2"></i>Schedule Maintenance for @selectedVehicle.Brand @selectedVehicle.Model
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseMaintenanceModal"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@maintenanceModel" OnValidSubmit="CreateMaintenance">
                            <div class="mb-3">
                                <label class="form-label">Vehicle</label>
                                <input type="text" class="form-control" value="@selectedVehicle.Brand @selectedVehicle.Model (@selectedVehicle.RegistrationNumber)" disabled />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Type</label>
                                <select class="form-select" @bind="maintenanceModel.Type" required>
                                    @foreach (var type in Enum.GetValues<MaintenanceType>())
                                    {
                                        <option value="@((int)type)">@type</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Scheduled Date</label>
                                <input type="date" class="form-control" @bind="maintenanceModel.ScheduledDate" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" rows="3" @bind="maintenanceModel.Description" required placeholder="Describe the maintenance work needed..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estimated Cost ($)</label>
                                <input type="number" step="0.01" class="form-control" @bind="maintenanceModel.Cost" required />
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" @onclick="CloseMaintenanceModal">Cancel</button>
                                <button type="submit" class="btn btn-warning" disabled="@isProcessing">
                                    @if (isProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-calendar-check me-2"></i>Schedule Maintenance
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Report Damage Modal -->
    @if (showDamageModal && selectedVehicle != null)
    {
        <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle text-danger me-2"></i>Report Damage for @selectedVehicle.Brand @selectedVehicle.Model
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseDamageModal"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@damageModel" OnValidSubmit="CreateDamage">
                            <div class="mb-3">
                                <label class="form-label">Vehicle</label>
                                <input type="text" class="form-control" value="@selectedVehicle.Brand @selectedVehicle.Model (@selectedVehicle.RegistrationNumber)" disabled />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Severity</label>
                                <select class="form-select" @bind="damageModel.Severity" required>
                                    @foreach (var severity in Enum.GetValues<DamageSeverity>())
                                    {
                                        <option value="@((int)severity)">@severity</option>
                                    }
                                </select>
                                <small class="form-text text-muted">
                                    <strong>Minor:</strong> Cosmetic only | <strong>Moderate:</strong> Some functionality affected | 
                                    <strong>Major:</strong> Significant damage | <strong>Critical:</strong> Vehicle unsafe
                                </small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Reported Date</label>
                                <input type="date" class="form-control" @bind="damageModel.ReportedDate" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" rows="3" @bind="damageModel.Description" required placeholder="Describe the damage in detail..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estimated Repair Cost ($)</label>
                                <input type="number" step="0.01" class="form-control" @bind="damageModel.RepairCost" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Reported By</label>
                                <input type="text" class="form-control" @bind="damageModel.ReportedBy" placeholder="Name of person reporting (optional)" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Related Rental ID (Optional)</label>
                                <input type="number" class="form-control" @bind="damageModel.RentalId" placeholder="If damage occurred during a rental" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Image URL (Optional)</label>
                                <input type="text" class="form-control" @bind="damageModel.ImageUrl" placeholder="URL to damage photo" />
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" @onclick="CloseDamageModal">Cancel</button>
                                <button type="submit" class="btn btn-danger" disabled="@isProcessing">
                                    @if (isProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-exclamation-circle me-2"></i>Report Damage
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }

    .border-warning-thick {
        border: 3px solid #ffc107 !important;
    }
</style>

@code {
    private List<Vehicle> vehicles = new();
    private List<Vehicle> allVehicles = new();
    private List<CategoryModel> categories = new();
    private Vehicle? selectedVehicle = null;
    private int? selectedCategoryId = null;
    private bool isLoading = true;
    private bool isAdmin = false;
    private bool isEmployee = false;
    private bool isProcessing = false;
    private bool showMaintenanceModal = false;
    private bool showDamageModal = false;
    private string? successMessage;
    private string? errorMessage;

    private CreateMaintenanceDto maintenanceModel = new() { ScheduledDate = DateTime.Today };
    private CreateVehicleDamageDto damageModel = new() { ReportedDate = DateTime.Today };

    private string filterStatus = "";
    private string searchText = "";

    protected override async Task OnInitializedAsync()
    {
        var role = await AuthService.GetRoleAsync();
        isAdmin = role == "Admin";
        isEmployee = role == "Employee";
        
        // Load categories first
        categories = await ApiService.GetCategoriesAsync(activeOnly: true);
        
        await LoadVehicles();
    }

    private async Task LoadVehicles()
    {
        isLoading = true;
        allVehicles = await ApiService.GetVehiclesAsync();
        vehicles = allVehicles;
        ApplyFilters();
        isLoading = false;
    }

    private void FilterByCategoryId(int? categoryId)
    {
        selectedCategoryId = categoryId;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var filteredList = allVehicles.AsEnumerable();

        if (selectedCategoryId.HasValue)
        {
            filteredList = filteredList.Where(v => v.CategoryId == selectedCategoryId.Value);
        }

        if (!string.IsNullOrEmpty(filterStatus) && (isAdmin || isEmployee))
        {
            var status = (VehicleStatus)int.Parse(filterStatus);
            filteredList = filteredList.Where(v => v.Status == status);
        }

        if (!string.IsNullOrEmpty(searchText) && (isAdmin || isEmployee))
        {
            var search = searchText.ToLower();
            filteredList = filteredList.Where(v =>
                v.Brand.ToLower().Contains(search) ||
                v.Model.ToLower().Contains(search) ||
                v.RegistrationNumber.ToLower().Contains(search)
            );
        }

        vehicles = filteredList.ToList();
        StateHasChanged();
    }

    // Maintenance Modal Actions
    private void ShowMaintenanceModal(Vehicle vehicle)
    {
        selectedVehicle = vehicle;
        maintenanceModel = new CreateMaintenanceDto 
        { 
            VehicleId = vehicle.Id,
            ScheduledDate = DateTime.Today,
            Type = (int)MaintenanceType.Routine
        };
        showMaintenanceModal = true;
    }

    private void CloseMaintenanceModal()
    {
        showMaintenanceModal = false;
        selectedVehicle = null;
    }

    private async Task CreateMaintenance()
    {
        if (selectedVehicle == null) return;

        isProcessing = true;
        errorMessage = null;

        var result = await ApiServiceExtensions.CreateMaintenanceAsync(ApiService, HttpClient, maintenanceModel);
        
        if (result != null)
        {
            successMessage = $"Maintenance scheduled successfully for {selectedVehicle.Brand} {selectedVehicle.Model}!";
            showMaintenanceModal = false;
            selectedVehicle = null;
            await LoadVehicles();
        }
        else
        {
            errorMessage = "Failed to schedule maintenance. Please try again.";
        }

        isProcessing = false;
    }

    // Damage Modal Actions
    private void ShowDamageModal(Vehicle vehicle)
    {
        selectedVehicle = vehicle;
        damageModel = new CreateVehicleDamageDto 
        { 
            VehicleId = vehicle.Id,
            ReportedDate = DateTime.Today,
            Severity = (int)DamageSeverity.Minor
        };
        showDamageModal = true;
    }

    private void CloseDamageModal()
    {
        showDamageModal = false;
        selectedVehicle = null;
    }

    private async Task CreateDamage()
    {
        if (selectedVehicle == null) return;

        isProcessing = true;
        errorMessage = null;

        var result = await ApiServiceExtensions.CreateVehicleDamageAsync(ApiService, HttpClient, damageModel);
        
        if (result != null)
        {
            successMessage = $"Damage reported successfully for {selectedVehicle.Brand} {selectedVehicle.Model}!";
            showDamageModal = false;
            selectedVehicle = null;
            await LoadVehicles();
        }
        else
        {
            errorMessage = "Failed to report damage. Please try again.";
        }

        isProcessing = false;
    }

    // Navigation Actions
    private void ViewDetails(int vehicleId)
    {
        NavigationManager.NavigateTo($"/vehicles/{vehicleId}");
    }

    private void GoToAddVehicle()
    {
        NavigationManager.NavigateTo("/vehicles/add");
    }

    private void EditVehicle(int vehicleId)
    {
        NavigationManager.NavigateTo($"/vehicles/edit/{vehicleId}");
    }

    private async Task DeleteVehicle(int vehicleId)
    {
        if (!await ConfirmDelete()) return;

        try
        {
            await ApiService.DeleteVehicleAsync(vehicleId);
            successMessage = "Vehicle deleted successfully!";
            await LoadVehicles();
        }
        catch
        {
            errorMessage = "Failed to delete vehicle. It may be in use.";
        }
    }

    private async Task<bool> ConfirmDelete()
    {
        // In a real application, use a proper confirmation modal
        return await Task.FromResult(true);
    }

    private void GoToManageVehicles()
    {
        NavigationManager.NavigateTo("/vehicles/manage");
    }

    private string GetStatusBadgeClass(VehicleStatus status)
    {
        return status switch
        {
            VehicleStatus.Available => "bg-success",
            VehicleStatus.Reserved => "bg-info",
            VehicleStatus.Rented => "bg-warning text-dark",
            VehicleStatus.Maintenance => "bg-warning text-dark",
            VehicleStatus.Retired => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetVehicleCardClass(VehicleStatus status)
    {
        if ((isAdmin || isEmployee) && status == VehicleStatus.Maintenance)
        {
            return "border-warning-thick";
        }
        return "";
    }
}
