@page "/admin"
@layout AdminLayout
@inject Frontend.Services.IApiService ApiService
@inject Frontend.Services.IAuthService AuthService
@inject NavigationManager NavigationManager
@using Frontend.Models

<PageTitle>Admin Dashboard - Car Rental System</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="px-0">
    @if (isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (!isAuthorized)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="my-4">
            <strong>Access Denied</strong> - Admin or Employee privileges required.
        </MudAlert>
    }
    else
    {
        <MudStack Spacing="4">
            <!-- Header -->
            <MudPaper Elevation="0" Class="pa-6" Style="background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%); color: white; border-radius: 12px;">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h3" Style="font-weight: 700;">
                        <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-3" Size="Size.Large" />
                        Welcome Back, @username!
                    </MudText>
                    <MudText Typo="Typo.h6" Style="opacity: 0.9;">
                        Here's your system overview for today
                    </MudText>
                </MudStack>
            </MudPaper>

            @if (isLoading)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            }
            else
            {
                <!-- Statistics Cards -->
                <MudGrid Spacing="3">
                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="3" Style="height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <MudCardContent Class="pa-4">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Style="opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">Total Vehicles</MudText>
                                        <MudText Typo="Typo.h3" Style="font-weight: 700;">@vehicles.Count</MudText>
                                        <MudText Typo="Typo.body2" Style="opacity: 0.8;">In Fleet</MudText>
                                    </MudStack>
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 12px;">
                                        <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Size="Size.Large" />
                                    </div>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="3" Style="height: 100%; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                            <MudCardContent Class="pa-4">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Style="opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">Available</MudText>
                                        <MudText Typo="Typo.h3" Style="font-weight: 700;">@vehicles.Count(v => v.Status == VehicleStatus.Available)</MudText>
                                        <MudText Typo="Typo.body2" Style="opacity: 0.8;">Ready to Rent</MudText>
                                    </MudStack>
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 12px;">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" />
                                    </div>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="3" Style="height: 100%; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                            <MudCardContent Class="pa-4">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Style="opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">Active Rentals</MudText>
                                        <MudText Typo="Typo.h3" Style="font-weight: 700;">@rentals.Count(r => r.Status == RentalStatus.Active)</MudText>
                                        <MudText Typo="Typo.body2" Style="opacity: 0.8;">In Progress</MudText>
                                    </MudStack>
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 12px;">
                                        <MudIcon Icon="@Icons.Material.Filled.EventNote" Size="Size.Large" />
                                    </div>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="3" Style="height: 100%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                            <MudCardContent Class="pa-4">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Style="opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">Total Customers</MudText>
                                        <MudText Typo="Typo.h3" Style="font-weight: 700;">@customers.Count</MudText>
                                        <MudText Typo="Typo.body2" Style="opacity: 0.8;">Registered</MudText>
                                    </MudStack>
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 12px;">
                                        <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" />
                                    </div>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>

                <!-- Quick Actions -->
                <MudPaper Elevation="2" Class="pa-6">
                    <MudStack Spacing="3">
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.FlashOn" Class="mr-2" /> Quick Actions
                        </MudText>
                        <MudGrid Spacing="3" Class="mt-2">
                            <MudItem xs="12" sm="6" md="3">
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           FullWidth="true"
                                           Size="Size.Large"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           Href="/vehicles/add"
                                           Style="height: 60px; font-weight: 600;">
                                    Add Vehicle
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Primary" 
                                           FullWidth="true"
                                           Size="Size.Large"
                                           StartIcon="@Icons.Material.Filled.DirectionsCar"
                                           Href="/vehicles/manage"
                                           Style="height: 60px; font-weight: 600;">
                                    Manage Vehicles
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Primary" 
                                           FullWidth="true"
                                           Size="Size.Large"
                                           StartIcon="@Icons.Material.Filled.People"
                                           Href="/customers"
                                           Style="height: 60px; font-weight: 600;">
                                    View Customers
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Primary" 
                                           FullWidth="true"
                                           Size="Size.Large"
                                           StartIcon="@Icons.Material.Filled.EventNote"
                                           Href="/rentals/manage"
                                           Style="height: 60px; font-weight: 600;">
                                    View Rentals
                                </MudButton>
                            </MudItem>
                            @if (userRole == "Admin")
                            {
                                <MudItem xs="12" sm="6" md="3">
                                    <MudButton Variant="Variant.Outlined" 
                                               Color="Color.Primary" 
                                               FullWidth="true"
                                               Size="Size.Large"
                                               StartIcon="@Icons.Material.Filled.Category"
                                               Href="/admin/categories"
                                               Style="height: 60px; font-weight: 600;">
                                        Manage Categories
                                    </MudButton>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudStack>
                </MudPaper>

                <!-- Status Overview -->
                <MudGrid Spacing="3">
                    <MudItem xs="12" md="6">
                        <MudPaper Elevation="2" Class="pa-6" Style="height: 100%;">
                            <MudStack Spacing="3">
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">
                                    <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Class="mr-2" /> Vehicle Status Overview
                                </MudText>
                                <MudList T="string" Dense="false">
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">Available</MudText>
                                            <MudChip T="string" Color="Color.Success" Style="font-weight: 600;">@vehicles.Count(v => v.Status == VehicleStatus.Available)</MudChip>
                                        </MudStack>
                                    </MudListItem>
                                    <MudDivider />
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.DriveEta" IconColor="Color.Warning">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">Rented</MudText>
                                            <MudChip T="string" Color="Color.Warning" Style="font-weight: 600;">@vehicles.Count(v => v.Status == VehicleStatus.Rented)</MudChip>
                                        </MudStack>
                                    </MudListItem>
                                    <MudDivider />
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.Build" IconColor="Color.Secondary">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">Maintenance</MudText>
                                            <MudChip T="string" Color="Color.Secondary" Style="font-weight: 600;">@vehicles.Count(v => v.Status == VehicleStatus.Maintenance)</MudChip>
                                        </MudStack>
                                    </MudListItem>
                                    <MudDivider />
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.Cancel" IconColor="Color.Error">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">Retired</MudText>
                                            <MudChip T="string" Color="Color.Error" Style="font-weight: 600;">@vehicles.Count(v => v.Status == VehicleStatus.Retired)</MudChip>
                                        </MudStack>
                                    </MudListItem>
                                </MudList>
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudPaper Elevation="2" Class="pa-6" Style="height: 100%;">
                            <MudStack Spacing="3">
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">
                                    <MudIcon Icon="@Icons.Material.Filled.EventNote" Class="mr-2" /> Rental Status Overview
                                </MudText>
                                <MudList T="string" Dense="false">
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.Schedule" IconColor="Color.Info">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">Reserved</MudText>
                                            <MudChip T="string" Color="Color.Info" Style="font-weight: 600;">@rentals.Count(r => r.Status == RentalStatus.Reserved)</MudChip>
                                        </MudStack>
                                    </MudListItem>
                                    <MudDivider />
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.PlayArrow" IconColor="Color.Primary">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">Active</MudText>
                                            <MudChip T="string" Color="Color.Primary" Style="font-weight: 600;">@rentals.Count(r => r.Status == RentalStatus.Active)</MudChip>
                                        </MudStack>
                                    </MudListItem>
                                    <MudDivider />
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">Completed</MudText>
                                            <MudChip T="string" Color="Color.Success" Style="font-weight: 600;">@rentals.Count(r => r.Status == RentalStatus.Completed)</MudChip>
                                        </MudStack>
                                    </MudListItem>
                                    <MudDivider />
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.Cancel" IconColor="Color.Error">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">Cancelled</MudText>
                                            <MudChip T="string" Color="Color.Error" Style="font-weight: 600;">@rentals.Count(r => r.Status == RentalStatus.Cancelled)</MudChip>
                                        </MudStack>
                                    </MudListItem>
                                </MudList>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            }
        </MudStack>
    }
</MudContainer>

@code {
    private bool isAuthorized = false;
    private bool isLoading = true;
    private string? username;
    private string? userRole;
    private List<Vehicle> vehicles = new();
    private List<Customer> customers = new();
    private List<Rental> rentals = new();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        
        var role = await AuthService.GetRoleAsync();
        username = await AuthService.GetUsernameAsync();
        userRole = role;
        isAuthorized = role == "Admin" || role == "Employee";

        if (!isAuthorized)
        {
            isLoading = false;
            NavigationManager.NavigateTo("/");
            return;
        }

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        
        try
        {
            vehicles = await ApiService.GetVehiclesAsync();
            customers = await ApiService.GetCustomersAsync();
            rentals = await ApiService.GetRentalsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        
        isLoading = false;
    }
}
