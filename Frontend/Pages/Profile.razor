@page "/profile"
@layout CustomerLayout
@inject IApiService ApiService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using Frontend.Models

<PageTitle>My Profile - Car Rental System</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudStack Spacing="4">
        <!-- Header -->
        <MudPaper Elevation="0" Class="pa-4" Style="background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%);">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h3" Style="color: white;">
                        <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Size="Size.Large" Class="mr-2" />
                        <strong>My Profile</strong>
                    </MudText>
                    <MudText Typo="Typo.body1" Style="color: rgba(255,255,255,0.9);">
                        Manage your personal information and view your membership details
                    </MudText>
                </MudStack>
                @if (customer != null)
                {
                    <MudChip T="string" 
                             Size="Size.Large" 
                             Color="@GetTierColor(customer.Tier)" 
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.Star">
                        @customer.Tier Member
                    </MudChip>
                }
            </MudStack>
        </MudPaper>

        @if (isLoading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else if (customer == null)
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
                <strong>Profile Not Found</strong> - Unable to load your profile information.
            </MudAlert>
        }
        else
        {
            <MudGrid Spacing="3">
                <!-- Personal Information -->
                <MudItem xs="12" md="8">
                    <MudPaper Elevation="2" Class="pa-4">
                        <MudStack Spacing="3">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h5">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" />
                                    Personal Information
                                </MudText>
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Primary" 
                                           StartIcon="@Icons.Material.Filled.Edit"
                                           Disabled="true">
                                    Edit Profile
                                </MudButton>
                            </MudStack>
                            
                            <MudDivider />

                            <MudGrid Spacing="2">
                                <MudItem xs="12" sm="6">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">First Name</MudText>
                                        <MudText Typo="Typo.body1"><strong>@customer.FirstName</strong></MudText>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Last Name</MudText>
                                        <MudText Typo="Typo.body1"><strong>@customer.LastName</strong></MudText>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Email</MudText>
                                        <MudText Typo="Typo.body1">
                                            <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Class="mr-1" />
                                            @customer.Email
                                        </MudText>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Phone Number</MudText>
                                        <MudText Typo="Typo.body1">
                                            <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Class="mr-1" />
                                            @customer.PhoneNumber
                                        </MudText>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Cake" Color="Color.Secondary" />
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Date of Birth</MudText>
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">@(customer.DateOfBirth?.ToString("MMM dd, yyyy") ?? "Not provided")</MudText>
                                        </MudStack>
                                    </MudStack>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Driver's License</MudText>
                                        <MudText Typo="Typo.body1">
                                            <MudIcon Icon="@Icons.Material.Filled.CreditCard" Size="Size.Small" Class="mr-1" />
                                            @customer.DriverLicenseNumber
                                        </MudText>
                                    </MudStack>
                                </MudItem>

                                @if (!string.IsNullOrEmpty(customer.Address))
                                {
                                    <MudItem xs="12">
                                        <MudStack Spacing="1">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Address</MudText>
                                            <MudText Typo="Typo.body1">
                                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                                @customer.Address
                                            </MudText>
                                        </MudStack>
                                    </MudItem>
                                }

                                <MudItem xs="12">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Member Since</MudText>
                                        <MudText Typo="Typo.body1">
                                            <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" Class="mr-1" />
                                            @customer.RegistrationDate.ToString("MMMM dd, yyyy")
                                        </MudText>
                                    </MudStack>
                                </MudItem>
                            </MudGrid>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <!-- Membership & Statistics -->
                <MudItem xs="12" md="4">
                    <MudStack Spacing="3">
                        <!-- Membership Card -->
                        <MudPaper Elevation="2" Class="pa-4" Style="@GetTierGradient(customer.Tier)">
                            <MudStack Spacing="2" AlignItems="AlignItems.Center" Class="text-center">
                                <MudIcon Icon="@Icons.Material.Filled.CardMembership" 
                                         Size="Size.Large" 
                                         Style="color: white; font-size: 3rem;" />
                                <MudText Typo="Typo.h5" Style="color: white;">
                                    <strong>@customer.Tier Member</strong>
                                </MudText>
                                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                                    @GetTierDescription(customer.Tier)
                                </MudText>
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Surface" 
                                           FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.TrendingUp">
                                    Upgrade Membership
                                </MudButton>
                            </MudStack>
                        </MudPaper>

                        <!-- Statistics -->
                        <MudPaper Elevation="2" Class="pa-4">
                            <MudStack Spacing="3">
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.Analytics" Class="mr-2" />
                                    My Statistics
                                </MudText>
                                
                                <MudDivider />

                                <MudStack Spacing="2">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Rentals</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                            @totalRentals
                                        </MudChip>
                                    </MudStack>

                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">Active Rentals</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success">
                                            @activeRentals
                                        </MudChip>
                                    </MudStack>

                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Spent</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                            $@totalSpent.ToString("N2")
                                        </MudChip>
                                    </MudStack>

                                    <MudDivider />

                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Primary" 
                                               FullWidth="true"
                                               StartIcon="@Icons.Material.Filled.History"
                                               Href="/rental-history">
                                        View Full History
                                    </MudButton>
                                </MudStack>
                            </MudStack>
                        </MudPaper>

                        <!-- Quick Actions -->
                        <MudPaper Elevation="2" Class="pa-4">
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.FlashOn" Class="mr-2" />
                                    Quick Actions
                                </MudText>
                                
                                <MudDivider />

                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Primary" 
                                           FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.DirectionsCar"
                                           Href="/vehicles/browse">
                                    Browse Vehicles
                                </MudButton>

                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Secondary" 
                                           FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.EventNote"
                                           Href="/my-rentals">
                                    My Rentals
                                </MudButton>

                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Warning" 
                                           FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.ReportProblem">
                                    Report Issue
                                </MudButton>
                            </MudStack>
                        </MudPaper>
                    </MudStack>
                </MudItem>
            </MudGrid>
        }
    </MudStack>
</MudContainer>

@code {
    private Customer? customer;
    private List<Rental> rentals = new();
    private bool isLoading = true;
    private int totalRentals = 0;
    private int activeRentals = 0;
    private decimal totalSpent = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfile();
    }

    private async Task LoadProfile()
    {
        isLoading = true;
        try
        {
            // Get current customer profile using /api/customers/me
            customer = await ApiService.GetMyProfileAsync();

            if (customer != null)
            {
                // Load rentals for statistics
                rentals = await ApiService.GetMyRentalsAsync();
                totalRentals = rentals.Count;
                activeRentals = rentals.Count(r => r.Status == RentalStatus.Active || r.Status == RentalStatus.Reserved);
                totalSpent = rentals.Where(r => r.Status == RentalStatus.Completed).Sum(r => r.TotalCost);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading profile: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private Color GetTierColor(CustomerTier tier)
    {
        return tier switch
        {
            CustomerTier.Platinum => Color.Dark,
            CustomerTier.Gold => Color.Warning,
            CustomerTier.Silver => Color.Info,
            _ => Color.Primary
        };
    }

    private string GetTierGradient(CustomerTier tier)
    {
        return tier switch
        {
            CustomerTier.Platinum => "background: linear-gradient(135deg, #434343 0%, #000000 100%);",
            CustomerTier.Gold => "background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);",
            CustomerTier.Silver => "background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);",
            _ => "background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);"
        };
    }

    private string GetTierDescription(CustomerTier tier)
    {
        return tier switch
        {
            CustomerTier.Platinum => "Premium benefits and exclusive perks",
            CustomerTier.Gold => "Enhanced rewards and priority service",
            CustomerTier.Silver => "Special discounts and benefits",
            _ => "Standard membership with great value"
        };
    }
}
