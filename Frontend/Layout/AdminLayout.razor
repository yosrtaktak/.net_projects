@inherits LayoutComponentBase
@inject IAuthService AuthService
@inject NavigationManager Navigation

<MudLayout>
    <MudDrawer @bind-Open="@_drawerOpen" Elevation="0" Variant="@DrawerVariant.Responsive" Breakpoint="Breakpoint.Lg"
               Style="border-right: 1px solid #e2e8f0;">
        <MudDrawerHeader Class="px-4 py-4" Style="min-height: 72px; border-bottom: 1px solid #e2e8f0;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Style="color: white; font-size: 1.5rem;" />
                </div>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.subtitle1" Style="font-weight: 700; color: #1e293b;">Car Rental</MudText>
                    <MudChip T="string" Size="Size.Small" Style="background: #f0fdfa; color: #0d9488; font-weight: 600; font-size: 0.7rem;">
                        @userRole
                    </MudChip>
                </MudStack>
            </MudStack>
        </MudDrawerHeader>
        
        <MudNavMenu Class="px-2 py-3">
            <MudNavLink Href="/admin" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard" Class="mb-1" 
                        Style="border-radius: 10px; margin: 2px 0;">
                Dashboard
            </MudNavLink>
            
            @if (isAdmin)
            {
                <!-- Admin-only navigation -->
                <MudText Typo="Typo.caption" Class="px-3 pt-4 pb-2" Style="color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    Fleet Management
                </MudText>
                <MudNavLink Href="/vehicles/manage" Icon="@Icons.Material.Filled.DirectionsCar" Style="border-radius: 10px; margin: 2px 0;">
                    Manage Vehicles
                </MudNavLink>
                <MudNavLink Href="/maintenances" Icon="@Icons.Material.Filled.Build" Style="border-radius: 10px; margin: 2px 0;">
                    Maintenance
                </MudNavLink>
                <MudNavLink Href="/damages" Icon="@Icons.Material.Filled.Warning" Style="border-radius: 10px; margin: 2px 0;">
                    Damages
                </MudNavLink>
                
                <MudText Typo="Typo.caption" Class="px-3 pt-4 pb-2" Style="color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    Business
                </MudText>
                <MudNavLink Href="/rentals/manage" Icon="@Icons.Material.Filled.EventNote" Style="border-radius: 10px; margin: 2px 0;">
                    All Rentals
                </MudNavLink>
                <MudNavLink Href="/customers" Icon="@Icons.Material.Filled.People" Style="border-radius: 10px; margin: 2px 0;">
                    Customers
                </MudNavLink>
                <MudNavLink Href="/reports" Icon="@Icons.Material.Filled.Assessment" Style="border-radius: 10px; margin: 2px 0;">
                    Reports
                </MudNavLink>
                
                <MudText Typo="Typo.caption" Class="px-3 pt-4 pb-2" Style="color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    System
                </MudText>
                <MudNavLink Href="/admin/categories" Icon="@Icons.Material.Filled.Category" Style="border-radius: 10px; margin: 2px 0;">
                    Categories
                </MudNavLink>
                <MudNavLink Href="/admin/employees" Icon="@Icons.Material.Filled.SupervisedUserCircle" Style="border-radius: 10px; margin: 2px 0;">
                    Employees
                </MudNavLink>
            }
            else
            {
                <!-- Employee navigation -->
                <MudText Typo="Typo.caption" Class="px-3 pt-4 pb-2" Style="color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    Operations
                </MudText>
                <MudNavLink Href="/vehicles/manage" Icon="@Icons.Material.Filled.DirectionsCar" Style="border-radius: 10px; margin: 2px 0;">
                    Manage Vehicles
                </MudNavLink>
                <MudNavLink Href="/rentals/manage" Icon="@Icons.Material.Filled.EventNote" Style="border-radius: 10px; margin: 2px 0;">
                    Manage Rentals
                </MudNavLink>
                <MudNavLink Href="/customers" Icon="@Icons.Material.Filled.People" Style="border-radius: 10px; margin: 2px 0;">
                    Customers
                </MudNavLink>
                <MudNavLink Href="/maintenances" Icon="@Icons.Material.Filled.Build" Style="border-radius: 10px; margin: 2px 0;">
                    Maintenance
                </MudNavLink>
                <MudNavLink Href="/damages" Icon="@Icons.Material.Filled.Warning" Style="border-radius: 10px; margin: 2px 0;">
                    Damages
                </MudNavLink>
                <MudNavLink Href="/reports" Icon="@Icons.Material.Filled.Assessment" Style="border-radius: 10px; margin: 2px 0;">
                    Reports
                </MudNavLink>
            }
        </MudNavMenu>
        
        <MudSpacer />
        
        <MudDivider Class="my-2" />
        <MudStack Class="px-4 py-4" Spacing="3">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudAvatar Style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; font-weight: 600;" Size="Size.Medium">
                    @GetInitials()
                </MudAvatar>
                <MudStack Spacing="0" Style="flex: 1; min-width: 0;">
                    <MudText Typo="Typo.body2" Style="font-weight: 600; color: #1e293b; overflow: hidden; text-overflow: ellipsis;">@username</MudText>
                    <MudText Typo="Typo.caption" Style="color: #64748b;">@userRole</MudText>
                </MudStack>
            </MudStack>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Primary" 
                       FullWidth="true" 
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Person"
                       Href="/admin/profile"
                       Style="border-radius: 8px;">
                My Profile
            </MudButton>
            <MudButton Variant="Variant.Text" 
                       Color="Color.Error" 
                       FullWidth="true" 
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Logout"
                       OnClick="HandleLogout"
                       Style="border-radius: 8px;">
                Sign Out
            </MudButton>
        </MudStack>
    </MudDrawer>

    <!-- Mobile AppBar - only visible on smaller screens -->
    <MudHidden Breakpoint="Breakpoint.LgAndUp">
        <MudAppBar Elevation="1" Style="background: white; border-bottom: 1px solid #e2e8f0;">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Style="color: #475569;" OnClick="@ToggleDrawer" />
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Style="color: white; font-size: 1.25rem;" />
                </div>
                <MudText Typo="Typo.subtitle1" Style="font-weight: 700; color: #1e293b;">Car Rental</MudText>
            </MudStack>
            <MudSpacer />
            <MudChip T="string" Size="Size.Small" Style="background: #f0fdfa; color: #0d9488; font-weight: 600;">
                @userRole
            </MudChip>
        </MudAppBar>
    </MudHidden>

    <MudMainContent Style="background-color: #f8fafc;">
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-6 px-4" Style="min-height: calc(100vh - 80px);">
            @Body
        </MudContainer>
        
        <!-- Admin Footer -->
        <MudPaper Elevation="0" Square="true" Class="mt-auto" Style="background: white; border-top: 1px solid #e2e8f0;">
            <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-3">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.body2" Style="color: #64748b;">
                        &copy; @DateTime.Now.Year Car Rental System - @userRole Portal
                    </MudText>
                    <MudStack Row="true" Spacing="4">
                    </MudStack>
                </MudStack>
            </MudContainer>
        </MudPaper>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private string? username;
    private string? userRole;
    private bool isAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserState();
    }

    private async Task LoadUserState()
    {
        try
        {
            var authenticated = await AuthService.IsAuthenticatedAsync();
            if (!authenticated)
            {
                Navigation.NavigateTo("/login", true);
                return;
            }

            username = await AuthService.GetUsernameAsync();
            userRole = await AuthService.GetRoleAsync();
            isAdmin = userRole == "Admin";
            
            // Ensure only Admin/Employee can access this layout
            if (userRole != "Admin" && userRole != "Employee")
            {
                Navigation.NavigateTo("/", true);
            }
        }
        catch (Exception)
        {
            Navigation.NavigateTo("/login", true);
        }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private string GetInitials()
    {
        if (string.IsNullOrEmpty(username)) return "?";
        var parts = username.Split(' ');
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return username.Substring(0, Math.Min(2, username.Length)).ToUpper();
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }
}
