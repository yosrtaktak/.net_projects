@inherits LayoutComponentBase
@inject IAuthService AuthService
@inject NavigationManager Navigation

<MudLayout>
    <MudAppBar Elevation="2" Dense="false">
        <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Class="mr-2" />
        <MudText Typo="Typo.h6">Car Rental System</MudText>
        <MudSpacer />
        
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudButton Href="/" Variant="Variant.Text" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.Home">
                Home
            </MudButton>
            <MudButton Href="/vehicles/browse" Variant="Variant.Text" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.DirectionsCar">
                Browse Vehicles
            </MudButton>
            @if (isAuthenticated)
            {
                <MudButton Href="/my-rentals" Variant="Variant.Text" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.EventNote">
                    My Rentals
                </MudButton>
            }
        </MudHidden>
        
        @if (isAuthenticated)
        {
            <MudMenu Icon="@Icons.Material.Filled.Person" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                <MudStack Class="pa-4" Spacing="1" Style="min-width: 200px;">
                    <MudText Typo="Typo.body2"><strong>@username</strong></MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Customer</MudText>
                </MudStack>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Filled.Person" Href="/profile">My Profile</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.EventNote" Href="/my-rentals">My Rentals</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.History" Href="/rental-history">Rental History</MudMenuItem>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="HandleLogout" IconColor="Color.Error">
                    Logout
                </MudMenuItem>
            </MudMenu>
        }
        else
        {
            <MudButton Href="/login" Variant="Variant.Outlined" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.Login">
                Login
            </MudButton>
            <MudButton Href="/register" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.PersonAdd" Class="ml-2">
                Register
            </MudButton>
        }
        
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.End" OnClick="@ToggleDrawer" />
        </MudHidden>
    </MudAppBar>

    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        <MudDrawer @bind-Open="@_mobileDrawerOpen" Anchor="Anchor.End" Elevation="2" Variant="DrawerVariant.Temporary">
            <MudDrawerHeader>
                <MudText Typo="Typo.h6">Menu</MudText>
            </MudDrawerHeader>
            <MudNavMenu>
                <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home" OnClick="@ToggleDrawer">Home</MudNavLink>
                <MudNavLink Href="/vehicles/browse" Icon="@Icons.Material.Filled.DirectionsCar" OnClick="@ToggleDrawer">Browse Vehicles</MudNavLink>
                @if (isAuthenticated)
                {
                    <MudNavLink Href="/my-rentals" Icon="@Icons.Material.Filled.EventNote" OnClick="@ToggleDrawer">My Rentals</MudNavLink>
                }
            </MudNavMenu>
        </MudDrawer>
    </MudHidden>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4" Style="min-height: calc(100vh - 200px);">
            @Body
        </MudContainer>
    </MudMainContent>

    <!-- Footer -->
    <MudPaper Elevation="0" Square="true" Class="mt-auto" Style="background-color: var(--mud-palette-surface); border-top: 1px solid var(--mud-palette-divider);">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-6">
            <MudGrid Spacing="4">
                <MudItem xs="12" sm="6" md="4">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Color="Color.Primary" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Color="Color.Primary">
                                <strong>Car Rental System</strong>
                            </MudText>
                        </MudStack>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Your trusted partner for quality vehicle rentals. We provide reliable, well-maintained vehicles for all your travel needs.
                        </MudText>
                    </MudStack>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="4">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6"><strong>Quick Links</strong></MudText>
                        <MudStack Spacing="1">
                            <MudLink Href="/" Color="Color.Secondary" Typo="Typo.body2">
                                <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Small" Class="mr-2" />
                                Home
                            </MudLink>
                            <MudLink Href="/vehicles/browse" Color="Color.Secondary" Typo="Typo.body2">
                                <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Size="Size.Small" Class="mr-2" />
                                Browse Vehicles
                            </MudLink>
                            @if (isAuthenticated)
                            {
                                <MudLink Href="/my-rentals" Color="Color.Secondary" Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.EventNote" Size="Size.Small" Class="mr-2" />
                                    My Rentals
                                </MudLink>
                                <MudLink Href="/profile" Color="Color.Secondary" Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-2" />
                                    My Profile
                                </MudLink>
                            }
                        </MudStack>
                    </MudStack>
                </MudItem>
                
                <MudItem xs="12" sm="12" md="4">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6"><strong>Contact Us</strong></MudText>
                        <MudStack Spacing="1">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Email" Color="Color.Secondary" Size="Size.Small" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">info@carrental.com</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Phone" Color="Color.Secondary" Size="Size.Small" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">+1 (555) 123-4567</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Color="Color.Secondary" Size="Size.Small" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">123 Main St, City, State</MudText>
                            </MudStack>
                            <MudStack Row="true" Spacing="2" Class="mt-2">
                                <MudIconButton Icon="@Icons.Custom.Brands.Facebook" Color="Color.Secondary" Size="Size.Small" />
                                <MudIconButton Icon="@Icons.Custom.Brands.Twitter" Color="Color.Secondary" Size="Size.Small" />
                                <MudIconButton Icon="@Icons.Custom.Brands.LinkedIn" Color="Color.Secondary" Size="Size.Small" />
                            </MudStack>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>
            
            <MudDivider Class="my-4" />
            
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    &copy; @DateTime.Now.Year Car Rental System. All rights reserved.
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Built with .NET 9 & Blazor WebAssembly
                </MudText>
            </MudStack>
        </MudContainer>
    </MudPaper>
</MudLayout>

@code {
    private bool isAuthenticated = false;
    private string? username;
    private bool _mobileDrawerOpen = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserState();
    }

    private async Task LoadUserState()
    {
        try
        {
            isAuthenticated = await AuthService.IsAuthenticatedAsync();
            if (isAuthenticated)
            {
                username = await AuthService.GetUsernameAsync();
                var role = await AuthService.GetRoleAsync();
                
                // Redirect admin/employee to admin portal if they try to access customer pages
                if (role == "Admin" || role == "Employee")
                {
                    var currentPath = new Uri(Navigation.Uri).AbsolutePath.ToLower();
                    // Allow public pages like home, but redirect from customer-specific features
                    if (currentPath.Contains("my-rentals") || currentPath.Contains("profile"))
                    {
                        Navigation.NavigateTo("/admin", true);
                    }
                }
            }
        }
        catch (Exception)
        {
            isAuthenticated = false;
        }
    }

    private void ToggleDrawer()
    {
        _mobileDrawerOpen = !_mobileDrawerOpen;
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }
}
